{{- if .Values.blobUpload.enabled }}
{{- $isLocal := .Values.isLocal | default false }}

{{/* Get storage accounts from ConfigMap or use provided values when running locally */}}
{{- $targetNamespace := .Values.targetNamespace | default .Release.Namespace }}
{{- $storageAccounts := list }}

{{- if not $isLocal }}
  {{- $configMapObj := lookup "v1" "ConfigMap" $targetNamespace "configmap-services" }}
  {{- if $configMapObj }}
    {{- $configMap := index $configMapObj.Object "data" }}
    {{- if $configMap }}
      {{- range $key, $value := $configMap }}
        {{- if hasPrefix "partition_storage_name_" $key }}
          {{- $storageAccounts = append $storageAccounts $value }}
        {{- end }}
      {{- end }}
    {{- else }}
      {{- fail (printf "ConfigMap 'configmap-services' in namespace '%s' has no data." $targetNamespace) }}
    {{- end }}
  {{- else }}
    {{- fail (printf "ConfigMap 'configmap-services' not found in namespace '%s'." $targetNamespace) }}
  {{- end }}
{{- else }}
{{/* Use storage accounts from values for local testing */}}
  {{- $storageAccounts = .Values.blobUpload.storageAccounts | default list }}
  {{- if eq (len $storageAccounts) 0 }}
    {{- fail "No storage accounts provided for local rendering. Please set 'blobUpload.storageAccounts' in your values file." }}
  {{- end }}
{{- end }}

{{/* Get resource group from config-map-values or use provided value when running locally */}}
{{- $resourceGroup := .Values.azure.resourceGroup | default "default-resource-group" }}

{{- if not $isLocal }}
  {{- $configMapValuesObj := lookup "v1" "ConfigMap" "default" "config-map-values" }}
  {{- if $configMapValuesObj }}
    {{- $configMapValues := index $configMapValuesObj.Object "data" }}
    {{- if $configMapValues }}
      {{- $valuesContent := index $configMapValues "values.yaml" }}
      {{- $valuesYaml := fromYaml $valuesContent }}
      {{- $resourceGroup = $valuesYaml.azure.resourceGroup | default $resourceGroup }}
    {{- end }}
  {{- end }}
{{- end }}

{{- if $storageAccounts }}
  {{- range $i, $storageAccount := $storageAccounts }}
---
apiVersion: v1
kind: PersistentVolume
metadata:
  annotations:
    pv.kubernetes.io/provisioned-by: blob.csi.azure.com
  name: {{ $.Release.Name }}-blob-pv-{{ $i }}
spec:
  storageClassName: azureblob-fuse-premium
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  mountOptions:
    - -o allow_other
    - --file-cache-timeout-in-seconds=120
  csi:
    driver: blob.csi.azure.com
    volumeHandle: {{ $storageAccount }}_{{ $.Values.blobUpload.container }}
    volumeAttributes:
      storageaccount: {{ $storageAccount }}
      containerName: {{ $.Values.blobUpload.container }}
      clientID: {{ $.Values.blobUpload.clientId | default $.Values.azure.clientId }}
      resourceGroup: {{ $resourceGroup }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ $.Release.Name }}-blob-pvc-{{ $i }}
  namespace: {{ $.Release.Namespace }}
spec:
  storageClassName: azureblob-fuse-premium
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  volumeName: {{ $.Release.Name }}-blob-pv-{{ $i }}
---
    {{- range $.Values.blobUpload.items }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $.Release.Name }}-blob-upload-{{ .name }}-{{ $i }}
  namespace: {{ $.Release.Namespace }}
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: workload-identity-sa
      volumes:
      - name: blob-storage
        persistentVolumeClaim:
          claimName: {{ $.Release.Name }}-blob-pvc-{{ $i }}
      containers:
      - name: blob-upload
        image: mcr.microsoft.com/cbl-mariner/base/core:2.0
        command: ["/bin/sh"]
        args:
        - -c
        - |
          # Install curl
          tdnf install -y curl
          
          # Download the file
          echo "Downloading file from {{ .url }}"
          curl -kso {{ .file }} "{{ .url }}"
          
          # Copy to mounted blob container
          cp {{ .file }} /mnt/blob/{{ $.Values.blobUpload.container }}/{{ .file }}
          
          echo "File uploaded to container {{ $.Values.blobUpload.container }} in storage account {{ $storageAccount }}"
        volumeMounts:
        - name: blob-storage
          mountPath: /mnt/blob
      restartPolicy: Never
    {{- end }} {{/* end range $.Values.blobUpload.items */}}
  {{- end }} {{/* end range $storageAccounts */}}
{{- end }} {{/* end if $storageAccounts */}}
{{- end }} {{/* end if .Values.blobUpload.enabled */}}