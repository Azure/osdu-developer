---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: airflow
  namespace: flux-system
  labels:
    name: airflow
spec:
  targetNamespace: airflow
  releaseName: airflow
  dependsOn:
    - name: azure-keyvault-airflow
      namespace: default
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 10
      strategy: rollback
  test:
    enable: true
  interval: 10m0s
  chart:
    spec:
      chart: airflow
      # version: 1.11.0
      sourceRef:
        kind: HelmRepository
        name: airflow
        namespace: flux-system
  values:

    # Version Isolation
    airflowVersion: 2.10.1
    defaultAirflowTag: 2.10.1

    # Airflow executor
    executor: KubernetesExecutor

    enableBuiltInSecretEnvVars:
      AIRFLOW__CORE__FERNET_KEY: true
      AIRFLOW__WEBSERVER__SECRET_KEY: false

    # Environment variables for all airflow containers
    env:
      - name: ENVIRONMENT
        value: dev

    # Admin user configuration
    admin:
      existingSecret: airflow-secrets
      usernameKey: username
      passwordKey: password

    # Disable the internal PostgreSQL chart
    postgresql:
      enabled: false

    # External PostgreSQL configuration
    data:
      metadataSecretName: airflow-secrets

    # Disable pgbouncer.
    # CloudNativePG provides native support for connection pooling with PgBouncer
    pgbouncer:
      enabled: false

    # Pull DAGS from file share and from a git repo
    dags:
      persistence:
        enabled: true
        existingClaim: airflow-dags-pvc
      gitSync:
        enabled: false

    logs:
      persistence:
        enabled: true
        existingClaim: airflow-logs-pvc

    config:
      webserver:
        expose_config: 'True'
        instance_name: OSDU
        enable_proxy_fix: 'True'
        # base_url: 'http://localhost/airflow'
      operators:
        default_owner: OSDU

    # We disable the log groomer sidecars because we use Azure File Storage for logs
    triggerer:
      logGroomerSidecar:
        enabled: false
    scheduler:
      logGroomerSidecar:
        enabled: false
    workers:
      logGroomerSidecar:
        enabled: false

    # Ensure we are using the secrets from Azure Key Vault
    enableBuiltInSecretEnvVars:
      AIRFLOW__CORE__FERNET_KEY: false
      AIRFLOW__WEBSERVER__SECRET_KEY: false
    fernetKeySecretName: keyvault-secrets
    webserverSecretKeySecretName: keyvault-secrets

    # Airflow create user job settings
    createUserJob:
      useHelmHooks: false

    # Airflow database migration job settings
    migrateDatabaseJob:
      useHelmHooks: false

    # Ensure this goes on the correct node pool.
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: agentpool
              operator: In
              values:
                - poolz1
                - poolz2
                - poolz3  # Adjust these values to match your node pools

    topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          release: airflow  # Adjust to match your Helm release name

    # Tolerations should be defined outside of affinity
    tolerations:
      - effect: NoSchedule
        key: app
        value: "cluster"







