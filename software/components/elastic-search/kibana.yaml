---
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: kibana
  namespace: elastic-search
spec:
  # version: 7.17.24
  version: 8.15.2
  elasticsearchRef:
    name: "elasticsearch"
  count: 3
  config:
    server.port: 5601
    server.publicBaseUrl: "https://localhost:5601/kibana"
    server.host: "localhost"
    server.basePath: "/kibana"
    # server.rewriteBasePath: true
  podTemplate:
    spec:
      tolerations:
        - effect: NoSchedule
          key: app
          value: "cluster"
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: agentpool
                    operator: In
                    values:
                      - poolz1
                      - poolz2
                      - poolz3
              - matchExpressions:
                  - key: topology.kubernetes.io/zone
                    operator: In
                    values:
                      - "$(REGION)-1"
                      - "$(REGION)-2"
                      - "$(REGION)-3"
      containers:
        # - name: kibana
        #   readinessProbe:
        #     failureThreshold: 3
        #     initialDelaySeconds: 10
        #     periodSeconds: 10
        #     successThreshold: 1
        #     exec:
        #       command:
        #         - /bin/bash
        #         - -c
        #         - curl -o /dev/null -w "%{http_code}" https://127.0.0.1:5601/login -k -s
          env:
            - name: xpack.encryptedSavedObjects.encryptionKey
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-credentials
                  key: key
            - name: ELASTICSEARCH_HOSTS
              value: "http://elasticsearch-es-http.elastic-search:9200"  # Adjust this URL to match your 
            - name: REGION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['topology.kubernetes.io/region']